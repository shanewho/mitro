(function(){function y(h){var p=function(e,a,b,d){var k=h.util.createBuffer(),f=e.length>>1,m=f+(e.length&1),s=e.substr(0,m),m=e.substr(f,m);e=h.util.createBuffer();f=h.hmac.create();b=a+b;var n=Math.ceil(d/16);a=Math.ceil(d/20);f.start("MD5",s);s=h.util.createBuffer();e.putBytes(b);for(var l=0;l<n;++l)f.start(null,null),f.update(e.getBytes()),e.putBuffer(f.digest()),f.start(null,null),f.update(e.bytes()+b),s.putBuffer(f.digest());f.start("SHA1",m);m=h.util.createBuffer();e.clear();e.putBytes(b);
for(l=0;l<a;++l)f.start(null,null),f.update(e.getBytes()),e.putBuffer(f.digest()),f.start(null,null),f.update(e.bytes()+b),m.putBuffer(f.digest());k.putBytes(h.util.xorBytes(s.getBytes(),m.getBytes(),d));return k},J=function(e,a,b){b=!1;try{var d=e.deflate(a.fragment.getBytes());a.fragment=h.util.createBuffer(d);a.length=d.length;b=!0}catch(k){}return b},K=function(e,a,b){b=!1;try{var d=e.inflate(a.fragment.getBytes());a.fragment=h.util.createBuffer(d);a.length=d.length;b=!0}catch(k){}return b},r=
function(e,a){var b=0;switch(a){case 1:b=e.getByte();break;case 2:b=e.getInt16();break;case 3:b=e.getInt24();break;case 4:b=e.getInt32()}return h.util.createBuffer(e.getBytes(b))},t=function(e,a,b){e.putInt(b.length(),a<<3);e.putBuffer(b)},b={Version:{major:3,minor:1},MaxFragment:15360,ConnectionEnd:{server:0,client:1},PRFAlgorithm:{tls_prf_sha256:0},BulkCipherAlgorithm:{none:null,rc4:0,des3:1,aes:2},CipherType:{stream:0,block:1,aead:2},MACAlgorithm:{none:null,hmac_md5:0,hmac_sha1:1,hmac_sha256:2,
hmac_sha384:3,hmac_sha512:4},CompressionMethod:{none:0,deflate:1},ContentType:{change_cipher_spec:20,alert:21,handshake:22,application_data:23,heartbeat:24},HandshakeType:{hello_request:0,client_hello:1,server_hello:2,certificate:11,server_key_exchange:12,certificate_request:13,server_hello_done:14,certificate_verify:15,client_key_exchange:16,finished:20},Alert:{}};b.Alert.Level={warning:1,fatal:2};b.Alert.Description={close_notify:0,unexpected_message:10,bad_record_mac:20,decryption_failed:21,record_overflow:22,
decompression_failure:30,handshake_failure:40,bad_certificate:42,unsupported_certificate:43,certificate_revoked:44,certificate_expired:45,certificate_unknown:46,illegal_parameter:47,unknown_ca:48,access_denied:49,decode_error:50,decrypt_error:51,export_restriction:60,protocol_version:70,insufficient_security:71,internal_error:80,user_canceled:90,no_renegotiation:100};b.HeartbeatMessageType={heartbeat_request:1,heartbeat_response:2};b.CipherSuites={};b.getCipherSuite=function(e){var a=null,c;for(c in b.CipherSuites){var d=
b.CipherSuites[c];if(d.id[0]===e.charCodeAt(0)&&d.id[1]===e.charCodeAt(1)){a=d;break}}return a};b.handleUnexpected=function(e,a){(e.open||e.entity!==b.ConnectionEnd.client)&&e.error(e,{message:"Unexpected message. Received TLS record out of order.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.unexpected_message}})};b.handleHelloRequest=function(e,a,c){!e.handshaking&&0<e.handshakes&&(b.queue(e,b.createAlert({level:b.Alert.Level.warning,description:b.Alert.Description.no_renegotiation})),
b.flush(e));e.process()};b.parseHelloMessage=function(e,a,c){var d=null,k=e.entity===b.ConnectionEnd.client;if(38>c)e.error(e,{message:k?"Invalid ServerHello message. Message too short.":"Invalid ClientHello message. Message too short.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.illegal_parameter}});else{a=a.fragment;var f=a.length(),d={version:{major:a.getByte(),minor:a.getByte()},random:h.util.createBuffer(a.getBytes(32)),session_id:r(a,1),extensions:[]};k?(d.cipher_suite=
a.getBytes(2),d.compression_method=a.getByte()):(d.cipher_suites=r(a,2),d.compression_methods=r(a,1));f=c-(f-a.length());if(0<f){for(c=r(a,2);0<c.length();)d.extensions.push({type:[c.getByte(),c.getByte()],data:r(c,2)});if(!k)for(c=0;c<d.extensions.length;++c)if(a=d.extensions[c],0===a.type[0]&&0===a.type[1])for(a=r(a.data,2);0<a.length()&&0===a.getByte();)e.session.serverNameList.push(r(a,2).getBytes())}d.version.major===b.Version.major&&d.version.minor===b.Version.minor||e.error(e,{message:"Incompatible TLS version.",
send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.protocol_version}});if(k)e.session.cipherSuite=b.getCipherSuite(d.cipher_suite);else for(c=h.util.createBuffer(d.cipher_suites.bytes());0<c.length()&&(e.session.cipherSuite=b.getCipherSuite(c.getBytes(2)),null===e.session.cipherSuite););if(null===e.session.cipherSuite)return e.error(e,{message:"No cipher suites in common.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.handshake_failure},cipherSuite:h.util.bytesToHex(d.cipher_suite)});
e.session.compressionMethod=k?d.compression_method:b.CompressionMethod.none}return d};b.createSecurityParameters=function(e,a){var c=e.entity===b.ConnectionEnd.client,d=a.random.bytes(),h=c?e.session.sp.client_random:d,c=c?d:b.createRandom().getBytes();e.session.sp={entity:e.entity,prf_algorithm:b.PRFAlgorithm.tls_prf_sha256,bulk_cipher_algorithm:null,cipher_type:null,enc_key_length:null,block_length:null,fixed_iv_length:null,record_iv_length:null,mac_algorithm:null,mac_length:null,mac_key_length:null,
compression_algorithm:e.session.compressionMethod,pre_master_secret:null,master_secret:null,client_random:h,server_random:c}};b.handleServerHello=function(e,a,c){a=b.parseHelloMessage(e,a,c);e.fail||(c=a.session_id.bytes(),0<c.length&&c===e.session.id?(e.expect=H,e.session.resuming=!0,e.session.sp.server_random=a.random.bytes()):(e.expect=y,e.session.resuming=!1,b.createSecurityParameters(e,a)),e.session.id=c,e.process())};b.handleClientHello=function(e,a,c){a=b.parseHelloMessage(e,a,c);if(!e.fail){c=
a.session_id.bytes();var d=null;e.sessionCache&&(d=e.sessionCache.getSession(c),null===d&&(c=""));0===c.length&&(c=h.random.getBytes(32));e.session.id=c;e.session.clientHelloVersion=a.version;e.session.sp=d?d.sp:{};null!==d?(e.expect=A,e.session.resuming=!0,e.session.sp.client_random=a.random.bytes()):(e.expect=!1!==e.verifyClient?L:B,e.session.resuming=!1,b.createSecurityParameters(e,a));e.open=!0;b.queue(e,b.createRecord({type:b.ContentType.handshake,data:b.createServerHello(e)}));e.session.resuming?
(b.queue(e,b.createRecord({type:b.ContentType.change_cipher_spec,data:b.createChangeCipherSpec()})),e.state.pending=b.createConnectionState(e),e.state.current.write=e.state.pending.write,b.queue(e,b.createRecord({type:b.ContentType.handshake,data:b.createFinished(e)}))):(b.queue(e,b.createRecord({type:b.ContentType.handshake,data:b.createCertificate(e)})),e.fail||(b.queue(e,b.createRecord({type:b.ContentType.handshake,data:b.createServerKeyExchange(e)})),!1!==e.verifyClient&&b.queue(e,b.createRecord({type:b.ContentType.handshake,
data:b.createCertificateRequest(e)})),b.queue(e,b.createRecord({type:b.ContentType.handshake,data:b.createServerHelloDone(e)}))));b.flush(e);e.process()}};b.handleCertificate=function(e,a,c){if(3>c)e.error(e,{message:"Invalid Certificate message. Message too short.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.illegal_parameter}});else{c=r(a.fragment,3);var d,k;a=[];try{for(;0<c.length();)d=r(c,3),k=h.asn1.fromDer(d),d=h.pki.certificateFromAsn1(k,!0),a.push(d)}catch(f){e.error(e,
{message:"Could not parse certificate list.",cause:f,send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.bad_certificate}})}e.fail||(d=e.entity===b.ConnectionEnd.client,!d&&!0!==e.verifyClient||0!==a.length?0===a.length?e.expect=d?x:B:(d?e.session.serverCertificate=a[0]:e.session.clientCertificate=a[0],b.verifyCertificateChain(e,a)&&(e.expect=d?x:B)):e.error(e,{message:d?"No server certificate provided.":"No client certificate provided.",send:!0,alert:{level:b.Alert.Level.fatal,
description:b.Alert.Description.illegal_parameter}}),e.process())}};b.handleServerKeyExchange=function(e,a,c){0<c?e.error(e,{message:"Invalid key parameters. Only RSA is supported.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.unsupported_certificate}}):(e.expect=v,e.process())};b.handleClientKeyExchange=function(e,a,c){if(48>c)e.error(e,{message:"Invalid key parameters. Only RSA is supported.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.unsupported_certificate}});
else{a=r(a.fragment,2).getBytes();c=null;if(e.getPrivateKey)try{c=e.getPrivateKey(e,e.session.serverCertificate),c=h.pki.privateKeyFromPem(c)}catch(d){e.error(e,{message:"Could not get private key.",cause:d,send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.internal_error}})}if(null===c)e.error(e,{message:"No private key set.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.internal_error}});else try{var k=e.session.sp;k.pre_master_secret=c.decrypt(a);
var f=e.session.clientHelloVersion;if(f.major!==k.pre_master_secret.charCodeAt(0)||f.minor!==k.pre_master_secret.charCodeAt(1))throw{message:"TLS version rollback attack detected."};}catch(m){k.pre_master_secret=h.random.getBytes(48)}}e.fail||(e.expect=A,null!==e.session.clientCertificate&&(e.expect=M),e.process())};b.handleCertificateRequest=function(e,a,c){3>c?e.error(e,{message:"Invalid CertificateRequest. Message too short.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.illegal_parameter}}):
(a=a.fragment,a={certificate_types:r(a,1),certificate_authorities:r(a,2)},e.session.certificateRequest=a,e.expect=F,e.process())};b.handleCertificateVerify=function(a,g,c){if(2>c)a.error(a,{message:"Invalid CertificateVerify. Message too short.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.illegal_parameter}});else{c=g.fragment;c.read-=4;g=c.bytes();c.read+=4;c=r(c,2).getBytes();var d=h.util.createBuffer();d.putBuffer(a.session.md5.digest());d.putBuffer(a.session.sha1.digest());
d=d.getBytes();try{if(!a.session.clientCertificate.publicKey.verify(d,c,"NONE"))throw{message:"CertificateVerify signature does not match."};a.session.md5.update(g);a.session.sha1.update(g)}catch(k){a.error(a,{message:"Bad signature in CertificateVerify.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.handshake_failure}})}a.fail||(a.expect=A,a.process())}};b.handleServerHelloDone=function(a,g,c){if(0<c)a.error(a,{message:"Invalid ServerHelloDone message. Invalid length.",
send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.record_overflow}});else if(null===a.serverCertificate)if(g={message:"No server certificate provided. Not enough security.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.insufficient_security}},c=a.verify(a,g.alert.description,depth,[]),!0===c)g=null;else{if(c||0===c)"object"!==typeof c||h.util.isArray(c)?"number"===typeof c&&(g.alert.description=c):(c.message&&(g.message=c.message),c.alert&&(g.alert.description=
c.alert));a.error(a,g)}a.fail||null===a.session.certificateRequest||(g=b.createRecord({type:b.ContentType.handshake,data:b.createCertificate(a)}),b.queue(a,g));a.fail||(g=b.createRecord({type:b.ContentType.handshake,data:b.createClientKeyExchange(a)}),b.queue(a,g),a.expect=N,g=function(a,e){null!==a.session.certificateRequest&&null!==a.session.clientCertificate&&b.queue(a,b.createRecord({type:b.ContentType.handshake,data:b.createCertificateVerify(a,e)}));b.queue(a,b.createRecord({type:b.ContentType.change_cipher_spec,
data:b.createChangeCipherSpec()}));a.state.pending=b.createConnectionState(a);a.state.current.write=a.state.pending.write;b.queue(a,b.createRecord({type:b.ContentType.handshake,data:b.createFinished(a)}));a.expect=H;b.flush(a);a.process()},null===a.session.certificateRequest||null===a.session.clientCertificate?g(a,null):b.getClientSignature(a,g))};b.handleChangeCipherSpec=function(a,g){if(1!==g.fragment.getByte())a.error(a,{message:"Invalid ChangeCipherSpec message received.",send:!0,alert:{level:b.Alert.Level.fatal,
description:b.Alert.Description.illegal_parameter}});else{var c=a.entity===b.ConnectionEnd.client;if(a.session.resuming&&c||!a.session.resuming&&!c)a.state.pending=b.createConnectionState(a);a.state.current.read=a.state.pending.read;if(!a.session.resuming&&c||a.session.resuming&&!c)a.state.pending=null;a.expect=c?G:O;a.process()}};b.handleFinished=function(a,g,c){c=g.fragment;c.read-=4;var d=c.bytes();c.read+=4;g=g.fragment.getBytes();c=h.util.createBuffer();c.putBuffer(a.session.md5.digest());c.putBuffer(a.session.sha1.digest());
var k=a.entity===b.ConnectionEnd.client;c=p(a.session.sp.master_secret,k?"server finished":"client finished",c.getBytes(),12);if(c.getBytes()!==g)a.error(a,{message:"Invalid verify_data in Finished message.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.decrypt_error}});else{a.session.md5.update(d);a.session.sha1.update(d);if(a.session.resuming&&k||!a.session.resuming&&!k)b.queue(a,b.createRecord({type:b.ContentType.change_cipher_spec,data:b.createChangeCipherSpec()})),
a.state.current.write=a.state.pending.write,a.state.pending=null,b.queue(a,b.createRecord({type:b.ContentType.handshake,data:b.createFinished(a)}));a.expect=k?P:Q;a.handshaking=!1;++a.handshakes;a.peerCertificate=k?a.session.serverCertificate:a.session.clientCertificate;a.sessionCache?(a.session={id:a.session.id,sp:a.session.sp},a.session.sp.keys=null):a.session=null;b.flush(a);a.isConnected=!0;a.connected(a);a.process()}};b.handleAlert=function(a,g){var c=g.fragment,c={level:c.getByte(),description:c.getByte()},
d;switch(c.description){case b.Alert.Description.close_notify:d="Connection closed.";break;case b.Alert.Description.unexpected_message:d="Unexpected message.";break;case b.Alert.Description.bad_record_mac:d="Bad record MAC.";break;case b.Alert.Description.decryption_failed:d="Decryption failed.";break;case b.Alert.Description.record_overflow:d="Record overflow.";break;case b.Alert.Description.decompression_failure:d="Decompression failed.";break;case b.Alert.Description.handshake_failure:d="Handshake failure.";
break;case b.Alert.Description.bad_certificate:d="Bad certificate.";break;case b.Alert.Description.unsupported_certificate:d="Unsupported certificate.";break;case b.Alert.Description.certificate_revoked:d="Certificate revoked.";break;case b.Alert.Description.certificate_expired:d="Certificate expired.";break;case b.Alert.Description.certificate_unknown:d="Certificate unknown.";break;case b.Alert.Description.illegal_parameter:d="Illegal parameter.";break;case b.Alert.Description.unknown_ca:d="Unknown certificate authority.";
break;case b.Alert.Description.access_denied:d="Access denied.";break;case b.Alert.Description.decode_error:d="Decode error.";break;case b.Alert.Description.decrypt_error:d="Decrypt error.";break;case b.Alert.Description.export_restriction:d="Export restriction.";break;case b.Alert.Description.protocol_version:d="Unsupported protocol version.";break;case b.Alert.Description.insufficient_security:d="Insufficient security.";break;case b.Alert.Description.internal_error:d="Internal error.";break;case b.Alert.Description.user_canceled:d=
"User canceled.";break;case b.Alert.Description.no_renegotiation:d="Renegotiation not supported.";break;default:d="Unknown error."}c.description===b.Alert.Description.close_notify?a.close():(a.error(a,{message:d,send:!1,origin:a.entity===b.ConnectionEnd.client?"server":"client",alert:c}),a.process())};b.handleHandshake=function(a,g){var c=g.fragment,d=c.getByte(),k=c.getInt24();if(k>c.length())a.fragmented=g,g.fragment=h.util.createBuffer(),c.read-=4,a.process();else{a.fragmented=null;c.read-=4;var f=
c.bytes(k+4);c.read+=4;d in z[a.entity][a.expect]?(a.entity!==b.ConnectionEnd.server||a.open||a.fail||(a.handshaking=!0,a.session={serverNameList:[],cipherSuite:null,compressionMethod:null,serverCertificate:null,clientCertificate:null,md5:h.md.md5.create(),sha1:h.md.sha1.create()}),d!==b.HandshakeType.hello_request&&d!==b.HandshakeType.certificate_verify&&d!==b.HandshakeType.finished&&(a.session.md5.update(f),a.session.sha1.update(f)),z[a.entity][a.expect][d](a,g,k)):b.handleUnexpected(a,g)}};b.handleApplicationData=
function(a,b){a.data.putBuffer(b.fragment);a.dataReady(a);a.process()};b.handleHeartbeat=function(a,g){var c=g.fragment,d=c.getByte(),k=c.getInt16(),c=c.getBytes(k);if(d===b.HeartbeatMessageType.heartbeat_request){if(a.handshaking||k>c.length)return a.process();b.queue(a,b.createRecord({type:b.ContentType.heartbeat,data:b.createHeartbeat(b.HeartbeatMessageType.heartbeat_response,c)}));b.flush(a)}else if(d===b.HeartbeatMessageType.heartbeat_response){if(c!==a.expectedHeartbeatPayload)return a.process();
a.heartbeatReceived&&a.heartbeatReceived(a,h.util.createBuffer(c))}a.process()};var y=1,x=2,v=3,F=4,H=5,G=6,P=7,N=8,L=1,B=2,M=3,A=4,O=5,Q=6,a=b.handleUnexpected,u=b.handleChangeCipherSpec,l=b.handleAlert,q=b.handleHandshake,w=b.handleApplicationData,n=b.handleHeartbeat,C=[];C[b.ConnectionEnd.client]=[[a,l,q,a,n],[a,l,q,a,n],[a,l,q,a,n],[a,l,q,a,n],[a,l,q,a,n],[u,l,a,a,n],[a,l,q,a,n],[a,l,q,w,n],[a,l,q,a,n]];C[b.ConnectionEnd.server]=[[a,l,q,a,n],[a,l,q,a,n],[a,l,q,a,n],[a,l,q,a,n],[u,l,a,a,n],[a,
l,q,a,n],[a,l,q,w,n],[a,l,q,a,n]];var u=b.handleHelloRequest,l=b.handleCertificate,q=b.handleServerKeyExchange,w=b.handleCertificateRequest,n=b.handleServerHelloDone,I=b.handleFinished,z=[];z[b.ConnectionEnd.client]=[[a,a,b.handleServerHello,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,l,q,w,n,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,a,q,w,n,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,a,a,w,n,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,a,a,a,n,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a],[u,
a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,I],[u,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a],[u,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]];z[b.ConnectionEnd.server]=[[a,b.handleClientHello,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,l,a,a,a,a,a,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,b.handleClientKeyExchange,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,b.handleCertificateVerify,a,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,I],[a,a,a,a,a,a,a,
a,a,a,a,a,a,a,a,a,a,a,a,a,a],[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]];b.generateKeys=function(a,b){var c=b.client_random+b.server_random;a.session.resuming||(b.master_secret=p(b.pre_master_secret,"master secret",c,48).bytes(),b.pre_master_secret=null);c=b.server_random+b.client_random;c=p(b.master_secret,"key expansion",c,2*b.mac_key_length+2*b.enc_key_length+2*b.fixed_iv_length);return{client_write_MAC_key:c.getBytes(b.mac_key_length),server_write_MAC_key:c.getBytes(b.mac_key_length),client_write_key:c.getBytes(b.enc_key_length),
server_write_key:c.getBytes(b.enc_key_length),client_write_IV:c.getBytes(b.fixed_iv_length),server_write_IV:c.getBytes(b.fixed_iv_length)}};b.createConnectionState=function(a){var g=a.entity===b.ConnectionEnd.client,c=function(){var a={sequenceNumber:[0,0],macKey:null,macLength:0,macFunction:null,cipherState:null,cipherFunction:function(a){return!0},compressionState:null,compressFunction:function(a){return!0},updateSequenceNumber:function(){4294967295===a.sequenceNumber[1]?(a.sequenceNumber[1]=0,
++a.sequenceNumber[0]):++a.sequenceNumber[1]}};return a},d={read:c(),write:c()};d.read.update=function(a,e){d.read.cipherFunction(e,d.read)?d.read.compressFunction(a,e,d.read)||a.error(a,{message:"Could not decompress record.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.decompression_failure}}):a.error(a,{message:"Could not decrypt record or bad MAC.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.bad_record_mac}});return!a.fail};d.write.update=
function(a,e){d.write.compressFunction(a,e,d.write)?d.write.cipherFunction(e,d.write)||a.error(a,{message:"Could not encrypt record.",send:!1,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.internal_error}}):a.error(a,{message:"Could not compress record.",send:!1,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.internal_error}});return!a.fail};if(a.session)switch(c=a.session.sp,a.session.cipherSuite.initSecurityParameters(c),c.keys=b.generateKeys(a,c),d.read.macKey=
g?c.keys.server_write_MAC_key:c.keys.client_write_MAC_key,d.write.macKey=g?c.keys.client_write_MAC_key:c.keys.server_write_MAC_key,a.session.cipherSuite.initConnectionState(d,a,c),c.compression_algorithm){case b.CompressionMethod.none:break;case b.CompressionMethod.deflate:d.read.compressFunction=K;d.write.compressFunction=J;break;default:throw{message:"Unsupported compression algorithm."};}return d};b.createRandom=function(){var a=new Date,a=+a+6E4*a.getTimezoneOffset(),b=h.util.createBuffer();b.putInt32(a);
b.putBytes(h.random.getBytes(28));return b};b.createRecord=function(a){return a.data?{type:a.type,version:{major:b.Version.major,minor:b.Version.minor},length:a.data.length(),fragment:a.data}:null};b.createAlert=function(a){var g=h.util.createBuffer();g.putByte(a.level);g.putByte(a.description);return b.createRecord({type:b.ContentType.alert,data:g})};b.createClientHello=function(a){for(var g=h.util.createBuffer(),c=0;c<a.cipherSuites.length;++c){var d=a.cipherSuites[c];g.putByte(d.id[0]);g.putByte(d.id[1])}var k=
g.length(),c=h.util.createBuffer();c.putByte(b.CompressionMethod.none);var f=c.length(),d=h.util.createBuffer();if(a.virtualHost){var m=h.util.createBuffer();m.putByte(0);m.putByte(0);var s=h.util.createBuffer();s.putByte(0);t(s,2,h.util.createBuffer(a.virtualHost));var l=h.util.createBuffer();t(l,2,s);t(m,2,l);d.putBuffer(m)}m=d.length();0<m&&(m+=2);s=a.session.id;k=s.length+1+2+4+28+2+k+1+f+m;f=h.util.createBuffer();f.putByte(b.HandshakeType.client_hello);f.putInt24(k);f.putByte(b.Version.major);
f.putByte(b.Version.minor);f.putBytes(a.session.sp.client_random);t(f,1,h.util.createBuffer(s));t(f,2,g);t(f,1,c);0<m&&t(f,2,d);return f};b.createServerHello=function(a){var g=a.session.id,c=g.length+1+2+4+28+2+1,d=h.util.createBuffer();d.putByte(b.HandshakeType.server_hello);d.putInt24(c);d.putByte(b.Version.major);d.putByte(b.Version.minor);d.putBytes(a.session.sp.server_random);t(d,1,h.util.createBuffer(g));d.putByte(a.session.cipherSuite.id[0]);d.putByte(a.session.cipherSuite.id[1]);d.putByte(a.session.compressionMethod);
return d};b.createCertificate=function(a){var g=a.entity===b.ConnectionEnd.client,c=null;a.getCertificate&&(c=a.getCertificate(a,g?a.session.certificateRequest:a.session.serverNameList));var d=h.util.createBuffer();if(null!==c)try{h.util.isArray(c)||(c=[c]);for(var k=null,f=0;f<c.length;++f){var m=h.pem.decode(c[f])[0];if("CERTIFICATE"!==m.type&&"X509 CERTIFICATE"!==m.type&&"TRUSTED CERTIFICATE"!==m.type)throw{message:'Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".',
headerType:m.type};if(m.procType&&"ENCRYPTED"===m.procType.type)throw{message:"Could not convert certificate from PEM; PEM is encrypted."};var s=h.util.createBuffer(m.body);null===k&&(k=h.asn1.fromDer(s.bytes(),!1));var l=h.util.createBuffer();t(l,3,s);d.putBuffer(l)}c=h.pki.certificateFromAsn1(k);g?a.session.clientCertificate=c:a.session.serverCertificate=c}catch(n){return a.error(a,{message:"Could not send certificate list.",cause:n,send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.bad_certificate}})}a=
3+d.length();g=h.util.createBuffer();g.putByte(b.HandshakeType.certificate);g.putInt24(a);t(g,3,d);return g};b.createClientKeyExchange=function(a){var g=h.util.createBuffer();g.putByte(b.Version.major);g.putByte(b.Version.minor);g.putBytes(h.random.getBytes(46));var c=a.session.sp;c.pre_master_secret=g.getBytes();g=a.session.serverCertificate.publicKey.encrypt(c.pre_master_secret);a=g.length+2;c=h.util.createBuffer();c.putByte(b.HandshakeType.client_key_exchange);c.putInt24(a);c.putInt16(g.length);
c.putBytes(g);return c};b.createServerKeyExchange=function(a){return h.util.createBuffer()};b.getClientSignature=function(a,g){var c=h.util.createBuffer();c.putBuffer(a.session.md5.digest());c.putBuffer(a.session.sha1.digest());c=c.getBytes();a.getSignature=a.getSignature||function(a,e,c){var g=null;if(a.getPrivateKey)try{g=a.getPrivateKey(a,a.session.clientCertificate),g=h.pki.privateKeyFromPem(g)}catch(s){a.error(a,{message:"Could not get private key.",cause:s,send:!0,alert:{level:b.Alert.Level.fatal,
description:b.Alert.Description.internal_error}})}null===g?a.error(a,{message:"No private key set.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.internal_error}}):e=g.sign(e,null);c(a,e)};a.getSignature(a,c,g)};b.createCertificateVerify=function(a,g){var c=g.length+2,d=h.util.createBuffer();d.putByte(b.HandshakeType.certificate_verify);d.putInt24(c);d.putInt16(g.length);d.putBytes(g);return d};b.createCertificateRequest=function(a){var g=h.util.createBuffer();g.putByte(1);
var c=h.util.createBuffer(),d;for(d in a.caStore.certs){var k=h.pki.distinguishedNameToAsn1(a.caStore.certs[d].subject);c.putBuffer(h.asn1.toDer(k))}a=1+g.length()+2+c.length();d=h.util.createBuffer();d.putByte(b.HandshakeType.certificate_request);d.putInt24(a);t(d,1,g);t(d,2,c);return d};b.createServerHelloDone=function(a){a=h.util.createBuffer();a.putByte(b.HandshakeType.server_hello_done);a.putInt24(0);return a};b.createChangeCipherSpec=function(){var a=h.util.createBuffer();a.putByte(1);return a};
b.createFinished=function(a){var g=h.util.createBuffer();g.putBuffer(a.session.md5.digest());g.putBuffer(a.session.sha1.digest());g=p(a.session.sp.master_secret,a.entity===b.ConnectionEnd.client?"client finished":"server finished",g.getBytes(),12);a=h.util.createBuffer();a.putByte(b.HandshakeType.finished);a.putInt24(g.length());a.putBuffer(g);return a};b.createHeartbeat=function(a,b,c){"undefined"===typeof c&&(c=b.length);var d=h.util.createBuffer();d.putByte(a);d.putInt16(c);d.putBytes(b);a=d.length();
c=Math.max(16,a-c-3);d.putBytes(h.random.getBytes(c));return d};b.queue=function(a,g){if(g){if(g.type===b.ContentType.handshake){var c=g.fragment.bytes();a.session.md5.update(c);a.session.sha1.update(c)}if(g.fragment.length()<=b.MaxFragment)c=[g];else{for(var c=[],d=g.fragment.bytes();d.length>b.MaxFragment;)c.push(b.createRecord({type:g.type,data:h.util.createBuffer(d.slice(0,b.MaxFragment))})),d=d.slice(b.MaxFragment);0<d.length&&c.push(b.createRecord({type:g.type,data:h.util.createBuffer(d)}))}for(d=
0;d<c.length&&!a.fail;++d){var k=c[d];a.state.current.write.update(a,k)&&a.records.push(k)}}};b.flush=function(a){for(var b=0;b<a.records.length;++b){var c=a.records[b];a.tlsData.putByte(c.type);a.tlsData.putByte(c.version.major);a.tlsData.putByte(c.version.minor);a.tlsData.putInt16(c.fragment.length());a.tlsData.putBuffer(a.records[b].fragment)}a.records=[];return a.tlsDataReady(a)};var D=function(a){switch(a){case !0:return!0;case h.pki.certificateError.bad_certificate:return b.Alert.Description.bad_certificate;
case h.pki.certificateError.unsupported_certificate:return b.Alert.Description.unsupported_certificate;case h.pki.certificateError.certificate_revoked:return b.Alert.Description.certificate_revoked;case h.pki.certificateError.certificate_expired:return b.Alert.Description.certificate_expired;case h.pki.certificateError.certificate_unknown:return b.Alert.Description.certificate_unknown;case h.pki.certificateError.unknown_ca:return b.Alert.Description.unknown_ca;default:return b.Alert.Description.bad_certificate}},
R=function(a){switch(a){case !0:return!0;case b.Alert.Description.bad_certificate:return h.pki.certificateError.bad_certificate;case b.Alert.Description.unsupported_certificate:return h.pki.certificateError.unsupported_certificate;case b.Alert.Description.certificate_revoked:return h.pki.certificateError.certificate_revoked;case b.Alert.Description.certificate_expired:return h.pki.certificateError.certificate_expired;case b.Alert.Description.certificate_unknown:return h.pki.certificateError.certificate_unknown;
case b.Alert.Description.unknown_ca:return h.pki.certificateError.unknown_ca;default:return h.pki.certificateError.bad_certificate}};b.verifyCertificateChain=function(a,g){try{h.pki.verifyCertificateChain(a.caStore,g,function(c,g,f){D(c);g=a.verify(a,c,g,f);if(!0!==g){if("object"===typeof g&&!h.util.isArray(g))throw c={message:"The application rejected the certificate.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.bad_certificate}},g.message&&(c.message=g.message),g.alert&&
(c.alert.description=g.alert),c;g!==c&&(g=R(g))}return g})}catch(c){if("object"!==typeof c||h.util.isArray(c))c={send:!0,alert:{level:b.Alert.Level.fatal,description:D(c)}};"send"in c||(c.send=!0);"alert"in c||(c.alert={level:b.Alert.Level.fatal,description:D(c.error)});a.error(a,c)}return!a.fail};b.createSessionCache=function(a,b){var c=null;if(a&&a.getSession&&a.setSession&&a.order)c=a;else{c={};c.cache=a||{};c.capacity=Math.max(b||100,1);c.order=[];for(var d in a)c.order.length<=b?c.order.push(d):
delete a[d];c.getSession=function(a){var b=null,e=null;a?e=h.util.bytesToHex(a):0<c.order.length&&(e=c.order[0]);if(null!==e&&e in c.cache){b=c.cache[e];delete c.cache[e];for(var d in c.order)if(c.order[d]===e){c.order.splice(d,1);break}}return b};c.setSession=function(a,b){if(c.order.length===c.capacity){var e=c.order.shift();delete c.cache[e]}e=h.util.bytesToHex(a);c.order.push(e);c.cache[e]=b}}return c};b.createConnection=function(a){var g=null,g=a.caStore?h.util.isArray(a.caStore)?h.pki.createCaStore(a.caStore):
a.caStore:h.pki.createCaStore(),c=a.cipherSuites||null;if(null===c){var c=[],d;for(d in b.CipherSuites)c.push(b.CipherSuites[d])}d=a.server?b.ConnectionEnd.server:b.ConnectionEnd.client;var k=a.sessionCache?b.createSessionCache(a.sessionCache):null,f={entity:d,sessionId:a.sessionId,caStore:g,sessionCache:k,cipherSuites:c,connected:a.connected,virtualHost:a.virtualHost||null,verifyClient:a.verifyClient||!1,verify:a.verify||function(a,b,c,e){return b},getCertificate:a.getCertificate||null,getPrivateKey:a.getPrivateKey||
null,getSignature:a.getSignature||null,input:h.util.createBuffer(),tlsData:h.util.createBuffer(),data:h.util.createBuffer(),tlsDataReady:a.tlsDataReady,dataReady:a.dataReady,heartbeatReceived:a.heartbeatReceived,closed:a.closed,error:function(c,d){d.origin=d.origin||(c.entity===b.ConnectionEnd.client?"client":"server");d.send&&(b.queue(c,b.createAlert(d.alert)),b.flush(c));var f=!1!==d.fatal;f&&(c.fail=!0);a.error(c,d);f&&c.close(!1)},deflate:a.deflate||null,inflate:a.inflate||null,reset:function(a){f.record=
null;f.session=null;f.peerCertificate=null;f.state={pending:null,current:null};f.expect=0;f.fragmented=null;f.records=[];f.open=!1;f.handshakes=0;f.handshaking=!1;f.isConnected=!1;f.fail=!(a||"undefined"===typeof a);f.input.clear();f.tlsData.clear();f.data.clear();f.state.current=b.createConnectionState(f)}};f.reset();f.handshake=function(a){if(f.entity!==b.ConnectionEnd.client)f.error(f,{message:"Cannot initiate handshake as a server.",fatal:!1});else if(f.handshaking)f.error(f,{message:"Handshake already in progress.",
fatal:!1});else{f.fail&&!f.open&&0===f.handshakes&&(f.fail=!1);f.handshaking=!0;a=a||"";var c=null;0<a.length&&(f.sessionCache&&(c=f.sessionCache.getSession(a)),null===c&&(a=""));0===a.length&&f.sessionCache&&(c=f.sessionCache.getSession(),null!==c&&(a=c.id));f.session={id:a,cipherSuite:null,compressionMethod:null,serverCertificate:null,certificateRequest:null,clientCertificate:null,sp:c?c.sp:{},md5:h.md.md5.create(),sha1:h.md.sha1.create()};f.session.sp.client_random=b.createRandom().getBytes();
f.open=!0;b.queue(f,b.createRecord({type:b.ContentType.handshake,data:b.createClientHello(f)}));b.flush(f)}};f.process=function(a){var c=0;a&&f.input.putBytes(a);if(!f.fail){null!==f.record&&f.record.ready&&f.record.fragment.isEmpty()&&(f.record=null);if(null===f.record){c=0;a=f.input;var e=a.length();5>e?c=5-e:(f.record={type:a.getByte(),version:{major:a.getByte(),minor:a.getByte()},length:a.getInt16(),fragment:h.util.createBuffer(),ready:!1},f.record.version.major===b.Version.major&&f.record.version.minor===
b.Version.minor||f.error(f,{message:"Incompatible TLS version.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.protocol_version}}))}if(!f.fail&&null!==f.record&&!f.record.ready){c=f;a=0;var e=c.input,d=e.length();d<c.record.length?a=c.record.length-d:(c.record.fragment.putBytes(e.getBytes(c.record.length)),e.compact(),c.state.current.read.update(c,c.record)&&(null!==c.fragmented&&(c.fragmented.type===c.record.type?(c.fragmented.fragment.putBuffer(c.record.fragment),c.record=
c.fragmented):c.error(c,{message:"Invalid fragmented record.",send:!0,alert:{level:b.Alert.Level.fatal,description:b.Alert.Description.unexpected_message}})),c.record.ready=!0));c=a}if(!f.fail&&null!==f.record&&f.record.ready)if(a=f.record,e=a.type-b.ContentType.change_cipher_spec,d=C[f.entity][f.expect],e in d)d[e](f,a);else b.handleUnexpected(f,a)}return c};f.prepare=function(a){b.queue(f,b.createRecord({type:b.ContentType.application_data,data:h.util.createBuffer(a)}));return b.flush(f)};f.prepareHeartbeatRequest=
function(a,c){a instanceof h.util.ByteBuffer&&(a=a.bytes());"undefined"===typeof c&&(c=a.length);f.expectedHeartbeatPayload=a;b.queue(f,b.createRecord({type:b.ContentType.heartbeat,data:b.createHeartbeat(b.HeartbeatMessageType.heartbeat_request,a,c)}));return b.flush(f)};f.close=function(a){!f.fail&&f.sessionCache&&f.session&&f.sessionCache.setSession(f.session.id,f.session);if(f.open){f.open=!1;f.input.clear();if(f.isConnected||f.handshaking)f.isConnected=f.handshaking=!1,b.queue(f,b.createAlert({level:b.Alert.Level.warning,
description:b.Alert.Description.close_notify})),b.flush(f);f.closed(f)}f.reset(a)};return f};h.tls=h.tls||{};for(var E in b)"function"!==typeof b[E]&&(h.tls[E]=b[E]);h.tls.prf_tls1=p;h.tls.hmac_sha1=function(a,b,c){var d=h.hmac.create();d.start("SHA1",a);a=h.util.createBuffer();a.putInt32(b[0]);a.putInt32(b[1]);a.putByte(c.type);a.putByte(c.version.major);a.putByte(c.version.minor);a.putInt16(c.length);a.putBytes(c.fragment.bytes());d.update(a.getBytes());return d.digest().getBytes()};h.tls.createSessionCache=
b.createSessionCache;h.tls.createConnection=b.createConnection}if("function"!==typeof define)if("object"===typeof module&&module.exports){var F=!0;define=function(h,p){p(require,module)}}else return"undefined"===typeof forge&&(forge={}),y(forge);var x,G=function(h,p){p.exports=function(p){var v=x.map(function(p){return h(p)}).concat(y);p=p||{};p.defined=p.defined||{};if(p.defined.tls)return p.tls;p.defined.tls=!0;for(var r=0;r<v.length;++r)v[r](p);return p.tls}},v=define;define=function(h,p){x="string"===
typeof h?p.slice(2):h.slice(2);if(F)return delete define,v.apply(null,Array.prototype.slice.call(arguments,0));define=v;return define.apply(null,Array.prototype.slice.call(arguments,0))};define("require module ./asn1 ./hmac ./md ./pem ./pki ./random ./util".split(" "),function(){G.apply(null,Array.prototype.slice.call(arguments,0))})})();
