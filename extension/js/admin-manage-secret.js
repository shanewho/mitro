$(function(){var k=$("#add-secret-members-modal");initAddAcl($("#acl-items"),k.find(".search"));$(".content").hide();$(".ugly-message").show();var f=NaN,l=null;try{var q=(new URI(window.location.href)).parseQuery().getParam("secretId"),f=parseInt(q,10)}catch(w){}if(isNaN(f))showErrorDialog("invalid secret id");else{var g=!1,h=!1,m=!1,c=null,n=function(){$(".content").hide();$(".ugly-message").text("Saving changes ...").show();var a=function(){c.setOrg(getOrgDropdownId($(".org-dropdown")));c.saveChanges(reload,
onBackgroundError)};$("#add-secret-members-modal").modal("hide");if(g){var b=getSecretDataFromPage();background.editSecret(f,b.serverData,b.clientData,"note"===c.getType()&&m||h?b.secretData:null,a,onBackgroundError)}else a()},p=function(a){a?$("#is-not-viewable-label").css("color","#4c5961"):$("#is-not-viewable-label").css("color","#a1a6aa")};$("#is-not-viewable").change(function(){g=!0;p($("#is-not-viewable").is(":checked"));$(".apply-changes-button").show()});$("#secret-note").change(function(){m=
!0});$("#secret-password").change(function(){h=!0});$("#secret-password").keyup(function(){$("#secret-password").attr("placeholder","")});$(".editable").keyup(function(){console.log("secret data is dirty. Should update when the user clicks apply.");$(".apply-changes-button").show();g=!0});registerLiveSearch($("#acl-item-search"),".modal-list > .acl-item");$(".add-to-acl").click(function(){var a=c.makeSecretAclTemplateData();$("#acl-items").html(templates["add-members-template"].render(a));replaceBlankImages($(".team-icon, .member-icon"));
k.modal("show");$(document).on("click","input[type=checkbox],.add-item",function(){$("#save-new-acls-button").show()});$("#save-new-acls-button").click(function(){for(var a=$("#acl-items").find("input[type=checkbox]:checked"),d=0;d<a.length;++d){var r=$(a[d]).closest(".acl-item");c.addAclItem(r)}n()});setTimeout(function(){$("#acl-item-search").focus()},100)});$("#show-password-button,#show-note-button").click(function(){if($("#is-web-password").is(":checked")){if("HIDE"===$("#show-password-button").text()){$("#secret-password").val("");
$("#secret-password").attr("placeholder","(password not shown)");$("#show-password-button").text("SHOW");return}$("#show-password-button").text("HIDE");$("#secret-password").val("Decrypting data ...");h=!1;$("#secret-password").attr("placeholder","")}else $("#secret-note").val("Decrypting data ...");c.getCriticalDataForDisplay(function(a){"note"===c.getType()?$("#secret-note").val(a):$("#secret-password").val(a)},onBackgroundError)});$("#copy-username-button").click(function(){var a=$(this),b=showSpinny(a);
helper.copyFromInput($("#secret-username"),function(){hideSpinny(a,b);a.text("COPIED");console.log("username copied")})});$("#copy-password-button").click(function(){var a=$(this),b=showSpinny(a);c.getCriticalDataForDisplay(function(d){copyText(d,function(){hideSpinny(a,b);a.text("COPIED");console.log("password copied")})},onBackgroundError)});var t=function(a){var b=a.clientData.type,d=a.clientData.username,c=a.clientData.loginUrl,s=a.clientData.title,e=getRenderedTitle(a);$("#secret-name").attr("placeholder",
e);$("#secret-name").val(s);$("#secret-url").val(c);$("#secret-username").val(d);a.isViewable?$("#is-not-viewable").prop("checked",!1):$("#is-not-viewable").prop("checked",!0);p($("#is-not-viewable").is(":checked"));a.canEditServerSecret&&c&&"note"!==b||$("#is-not-viewable-row").remove();"note"!==b?($(".for-manual").show(),$("#show-note-button").addClass("hide"),$("#secret-note").val(a.clientData.comment),$("#is-web-password").prop("checked",!0)):($(".for-manual").hide(),$("#show-note-button").removeClass("hide"),
$("#secret-note").val("(secret hidden)"),$("#is-secure-note").prop("checked",!0));b="number"===typeof a.owningOrgId?[{id:a.owningOrgId,name:a.owningOrgName}]:l.getOrganizations();initOrgDropdown($(".secret-org-dropdown-group"),b,a.owningOrgId);$(".org-dropdown li").click(function(){$(".apply-changes-button").show()})},u=function(a){t(a);var b=processUsersForRendering(userIdsToUserMap(a.users)),d=processGroupsForRendering(a.groupMap);$("#secret-acl-groups-members").html(templates["secret-acl-template"].render({users:b,
groups:d}));replaceBlankImages($(".member-icon, .team-icon"));a.groups.length||a.users.length?($(".no-existing-teams").hide(),$(".existing-teams").show()):($(".no-existing-teams").show(),$(".existing-teams").hide())},v=function(a,b){c=new SecretMutater(a,background,b);u(a);$(".content").show();$(".ugly-message").hide();$(document).on("click",".apply-changes-button",n);$(document).on("click",".remove-user",function(){var a=$(this);c.removeAclItem(a);a.closest("li").hide();$(".apply-changes-button").show()});
$(".delete-secret-link").click(function(){var b='Really delete secret "'+getRenderedTitle(a)+'"?';showDeleteDialog("Delete Secret",b,function(){showSpinny($(this));background.removeSecret(f,function(){helper.setLocation("secrets.html")},onBackgroundError)})});background.getIdentity(function(b){(function(a,b){var e;if(e=a.clientData.loginUrl)a:{e=["@mitro.co","@lectorius.com","@example.com"];for(var c=0;c<e.length;c++){var d=e[c];if(-1!==b.indexOf(d,b.length-d.length)){e=!0;break a}}e=!1}return e})(a,
b.uid)&&($(".change-password-button").show(),$(".change-password-button").click(function(){var a=function(a){a={secretId:f,newPassword:a};var c=showSpinny(b);background.changeRemotePassword(a,reload,function(a){hideSpinny(b,c);onBackgroundError(a)})},b=$(this);mitro.password.generatePasswordWithOptions({},function(b){a(b)},onBackgroundError)}))})};mitro.loadUserDataAndSecret(f,function(a,b){l=a;v(b,a)},onBackgroundError)}});
