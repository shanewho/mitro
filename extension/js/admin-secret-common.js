var getSecretDataFromPage=function(){$("#is-new-secret").is(":checked");var a=parseInt($("#secret-org-id").val(),10),a=isNaN(a)?null:a,b={},d={},c=null;if($("#is-web-password").is(":checked"))c="manual",d.password=$("#secret-password").val(),b.loginUrl=$("#secret-url").val(),b.username=$("#secret-username").val(),b.comment=$("#secret-note").val();else if($("#is-secure-note").is(":checked"))c="note",d.note=$("#secret-note").val();else throw Error("bad secret data");b.type=c;b.title=$("#secret-name").val();
b.title||(b.title=null);c=null;$("#is-not-viewable").length&&(c={isViewable:!$("#is-not-viewable").is(":checked")});return{clientData:b,serverData:c,secretData:d,orgId:a}},makeUserFromUserId=function(a){return{userId:a}},userIdsToUserMap=function(a){for(var b={},d=0;d<a.length;d++){var c=a[d];b[c]=makeUserFromUserId(c)}return b},nextCheckBoxId=0,processUsersForRendering=function(a,b){"undefined"===typeof b&&(b={});var d=[],c;for(c in a){var e=a[c];d.push({userId:e.userId,name:e.userId,email:"",photo:EMPTY_IMAGE,
checkboxId:"checkbox"+nextCheckBoxId++,checked:c in b})}d.sort(function(a,b){return lowercaseCompare(a.name,b.name)});return d},processGroupsForRendering=function(a,b){"undefined"===typeof b&&(b={});var d=[],c;for(c in a){var e=a[c];isVisibleGroup(e)&&d.push({groupId:e.groupId,image:EMPTY_IMAGE,name:e.name,checkboxId:"checkbox"+nextCheckBoxId++,checked:c in b})}d.sort(function(a,b){return lowercaseCompare(a.name,b.name)});return d},makeSecretAclTemplateData=function(a,b){var d=userIdsToUserMap(a.getUsersVisibleToSecret(b.secretId)),
c=userIdsToUserMap(b.users),e;for(e in c)d[e]=c[e];e=a.getGroupsVisibleToSecret(b.secretId);var f=b.groupMap,g;for(g in f)e[g]=f[g];d=processUsersForRendering(d,c);c=processGroupsForRendering(e,f);return{users:d,groups:c}},SecretMutater=function(a,b,d){this.secret=a;this.background=b;this.aclDirty=!1;this.allUsers=userIdsToUserMap(d.getUsersVisibleToSecret(a.secretId));this.existingUsers=userIdsToUserMap(a.users);for(var c in this.existingUsers)this.allUsers[c]=this.existingUsers[c];this.allGroups=
d.getGroupsVisibleToSecret(a.secretId);this.existingGroups=a.groupMap;for(var e in this.existingGroups)this.allGroups[e]=this.existingGroups[e]};SecretMutater.prototype.getType=function(){return this.secret.clientData.type};SecretMutater.prototype.addUser=function(a){a in this.existingUsers||(a in this.allUsers||(this.allUsers[a]=makeUserFromUserId(a)),this.existingUsers[a]=this.allUsers[a],this.aclDirty=!0)};
SecretMutater.prototype.addGroup=function(a){if(!(a in this.existingGroups)){if(!(a in this.allGroups))throw Error("Unknown group id: "+a);this.existingGroups[a]=this.allGroups[a];this.aclDirty=!0}};SecretMutater.prototype.removeUser=function(a){a in this.existingUsers&&(delete this.existingUsers[a],this.aclDirty=!0)};SecretMutater.prototype.removeGroup=function(a){a in this.existingGroups&&(delete this.existingGroups[a],this.aclDirty=!0)};
SecretMutater.prototype.addAclItem=function(a){var b=a.attr("data-user-id");a=a.attr("data-group-id");if("undefined"!==typeof b)this.addUser(b);else if("undefined"!==typeof a)this.addGroup(a);else throw Error("acl item without a user id or group id");};SecretMutater.prototype.removeAclItem=function(a){var b=a.attr("data-user-id");a=a.attr("data-group-id");if(b)this.removeUser(b);else if(a)this.removeGroup(a);else throw Error("acl item without a user id or group id");};
SecretMutater.prototype.setOrg=function(a){assert(null===a||"number"===typeof a);a!==this.secret.owningOrgId&&(this.secret.owningOrgId=a,this.aclDirty=!0)};SecretMutater.prototype.getCriticalDataForDisplay=function(a,b){background.getSiteSecretDataForDisplay(this.secret.secretId,function(b){var c=null,c="note"===b.clientData.type?b.criticalData.note:b.criticalData.password;a(c)},b)};
SecretMutater.prototype.saveChanges=function(a,b){if(this.aclDirty){var d=[],c;for(c in this.existingGroups)d.push(parseInt(c,10));c=Object.keys(this.existingUsers);var e=this.secret.owningOrgId;this.aclDirty=!1;this.background.editSiteShares(this.secret.secretId,d,c,e,a,function(){this.aclDirty=!0;b()})}else a&&a()};
SecretMutater.prototype.makeSecretAclTemplateData=function(){var a=processUsersForRendering(this.allUsers,this.existingUsers),b=processGroupsForRendering(this.allGroups,this.existingGroups);return{users:a,groups:b}};
