var AuditEventLoader;
(function(){var c={SIGNUP:"User signed up",MITRO_LOGIN:"User logged in",MITRO_AUTO_LOGIN:"User auto-logged in",EDIT_PASSWORD:"User changed password",NEW_DEVICE:"User added a device",INVITED_BY_USER:"User was invited"};$.extend(c,{CREATE_SECRET:"Secret created",DELETE_SECRET:"Secret removed",EDIT_SECRET:"Secret edited",GET_SECRET_CRITICAL_DATA_FOR_LOGIN:"Secret accessed",GRANTED_ACCESS_TO:" was granted access to ",REVOKED_ACCESS_TO:" was revoked access to "});$.extend(c,{CREATE_GROUP:"Group created",DELETE_GROUP:"Group removed",
EDIT_GROUP:"Group edited"});AuditEventLoader=function(a){this.SCROLL_MARGIN=200;this.loadSize=50;this.eventIds={};this.events=[];this.earliestTimestamp=null;this.loadInProgress=!1;this.hasMoreEvents=!0;this.orgId=a;var b=this;$(window).scroll(function(a){a=$(window).scrollTop();$(document).height()-a-$(window).height()<b.SCROLL_MARGIN&&!b.loadInProgress&&b.hasMoreEvents&&b.loadMoreEvents()})};AuditEventLoader.prototype.renderAuditEvents=function(){$("#audit-table").html(templates["audit-template"].render({events:this.events}))};
AuditEventLoader.prototype.processAuditEvent=function(a){if(!(a.action in c))return!1;a.date=formatTimestamp(a.timestampMs);a.actionString=c[a.action];"number"===typeof a.affectedUserId?(a.actionString=a.affectedUsername+a.actionString,a.linkText=a.secretTitle,a.linkUrl="../html/admin-manage-secret.html?secretId="+a.secretId):"number"===typeof a.secretId?(a.actionString+=": ",a.linkText=a.secretTitle,a.linkUrl="../html/admin-manage-secret.html?secretId="+a.secretId):"number"===typeof a.groupId&&(a.actionString+=
": ",a.linkText=a.groupName,a.linkUrl="../html/manage-team.html?id="+a.groupId);return!0};AuditEventLoader.prototype.loadMoreEvents=function(){var a=this;this.loadInProgress=!0;background.getAuditLog(this.orgId,0,this.loadSize,null,this.earliestTimestamp,function(b){console.log("audit log returned "+b.events.length+" events");for(var c=a.events.length,e=0;e<b.events.length;++e){var d=b.events[e];!(d.id in a.eventIds)&&(a.eventIds[d.id]=!0,a.processAuditEvent(d)&&a.events.push(d),null===a.earliestTimestamp||
d.timestampMs<a.earliestTimestamp)&&(a.earliestTimestamp=d.timestampMs)}a.renderAuditEvents(a.events);a.loadInProgress=!1;0===a.events.length-c&&(b.events.length<a.loadSize?a.hasMoreEvents=!1:(a.loadSize*=2,a.loadMoreEvents()))},onBackgroundError)};"undefined"!==typeof module&&module.exports&&(module.exports=AuditEventLoader)})();
