var mitro=mitro||{},kew=kew||require("./kew");mitro.Client=function(c){this.legacyApi=c};mitro.assert=function(c){if(!c)throw Error("Assertion failed");};mitro.Client.prototype.getRSAKeys=function(c){var a=kew.defer();this.legacyApi.getNewRSAKeysAsync(c,function(b){a.resolve(b)},function(b){a.reject(b)});return a};
var findEncryptedKeyForIdentity=function(c,a){for(var b=0;b<c.length;b++){var d=c[b];if(d.memberIdentity===a)return d.groupKeyEncryptedForMe}throw Error("Could not find acl for identity: "+a);},getAndDecryptGroupKey=function(c,a){var b=c.getIdentity(),b=findEncryptedKeyForIdentity(a.acls,b),b=c.decrypt(b);return c.cryptoLoadFromJson(b)};
mitro.Client.prototype.getGroupKey=function(c,a){var b=new kew.Promise,d=this.legacyApi;d.getGroup(c,a,function(a){b.resolve(a)},function(a){b.reject(a)});return b.then(function(a){return getAndDecryptGroupKey(d,a)})};mitro.Client.prototype.getPublicKeys=function(c,a){var b=kew.defer(),d=this.legacyApi;d.getPublicKeys(c,a,function(a){for(var c={},g=Object.getOwnPropertyNames(a),h=0;h<g.length;h++)c[g[h]]=d.cryptoLoadFromJson(a[g[h]]);b.resolve(c)},function(a){b.reject(a)});return b};
mitro.Client.prototype.postSigned=function(c,a,b){var d=kew.defer();this.legacyApi.postSigned(c,a,b,function(a){d.resolve(a)},function(a){d.reject(a)});return d};
mitro.Client.prototype.createOrganization=function(c,a,b,d,f){var e=this,g=mitro.combineUniqueUsers(a,b);mitro.assert(g.length==a.length+b.length);var h=e.getPublicKeys(g,null),g=e.getRSAKeys(1+g.length);kew.all([h,g]).then(function(d){d=mitro.makeOrganizationRequest(e.legacyApi,c,a,b,d[1],d[0]);return e.postSigned("/mitro-core/api/CreateOrganization",d,null)}).then(function(a){d(a)}).fail(function(a){f(a)}).done()};
mitro.combineUniqueUsers=function(c,a){for(var b=c.concat(a),d={},f=0;f<b.length;f++){var e=b[f];d.hasOwnProperty(e)||(d[e]=!0)}return Object.getOwnPropertyNames(d)};mitro.makeOrganizationRequest=function(c,a,b,d,f,e){var g=f.pop(),h=new mitro.CreateOrganizationRequest;h.name=a;h.publicKey=g.exportPublicKey().toJson();h.adminEncryptedKeys=mitro.encryptOrganizationKeyForAdmins(c,g,b,e);a=mitro.combineUniqueUsers(b,d);h.memberGroupKeys=mitro.createOrganizationMemberGroups(c,a,g,e,f);return h};
mitro.encryptOrganizationKeyForAdmins=function(c,a,b,d){a=a.toJson();for(var f={},e=0;e<b.length;e++)f[b[e]]=encryptForUser(c,a,b[e],d);return f};var encryptForUser=function(c,a,b,d){c=d[b];if(!c)throw Error("Missing public key for "+b);return c.encrypt(a)};
mitro.createOrganizationMemberGroups=function(c,a,b,d,f){mitro.assert(f.length>=a.length);for(var e={},g=0;g<a.length;g++){var h=f.pop(),l=h.toJson(),k=new mitro.PrivateGroupKeys;k.publicKey=h.exportPublicKey().toJson();k.keyEncryptedForUser=encryptForUser(c,l,a[g],d);k.keyEncryptedForOrganization=b.encrypt(l);e[a[g]]=k}return e};
mitro.Client.prototype.mutateOrganization=function(c,a,b,d){var f=this,e=mitro.combineUniqueUsers(c.membersToPromote,c.newMembers),g=f.getPublicKeys(e,a),e=f.getRSAKeys(e.length),g=g.then(function(b){return f.getGroupKey(c.orgId,a).then(function(a){return[b,a]})});kew.all([g,e]).then(function(b){b=mitro.makeMutateOrganizationRequestRpc(f.legacyApi,c,b[0][1],b[0][0],b[1]);return f.postSigned("/mitro-core/api/MutateOrganization",b,a)}).then(function(a){b(a)}).fail(function(a){d(a)}).done()};
mitro.makeMutateOrganizationRequestRpc=function(c,a,b,d,f){var e=new mitro.MutateOrganizationRequestRpc;e.orgId=a.orgId;e.promotedMemberEncryptedKeys=mitro.encryptOrganizationKeyForAdmins(c,b,a.membersToPromote,d);e.newMemberGroupKeys=mitro.createOrganizationMemberGroups(c,a.newMembers,b,d,f);e.adminsToDemote=a.adminsToDemote;e.membersToRemove=a.membersToRemove;return e};mitro.PrivateGroupKeys=function(){this.keyEncryptedForOrganization=this.keyEncryptedForUser=this.publicKey=null};
mitro.CreateOrganizationRequest=function(){this.publicKey=this.name=null;this.adminEncryptedKeys={};this.memberGroupKeys={}};mitro.MutateOrganizationRequestRpc=function(){this.orgId=0;this.promotedMemberEncryptedKeys={};this.newMemberGroupKeys={};this.adminsToDemote=[];this.membersToRemove=[]};"undefined"!==typeof module&&module.exports&&(module.exports=mitro);
