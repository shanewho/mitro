var forge=forge||require("node-forge"),mitro=mitro||{};
(function(){mitro.keycache={};var h=null;if("undefined"!==typeof window)h="undefined"!==typeof unsafeWindow?unsafeWindow.Worker:Worker;else if("undefined"!==typeof module&&module.exports){mitro.crappycrypto=require("./crappycrypto.js");mitro.crypto=require("./crypto.js");module.exports=mitro.keycache;try{h=require("webworker-threads").Worker}catch(l){if(!process.env.DISABLE_WEBWORKERS)throw l;}}mitro.keycache.CACHE_TARGET=2;var e=mitro.crypto;mitro.keycache.useCrappyCrypto=function(){if(!mitro.crappycrypto)throw Error("crappycrypto does not exist?");
e=mitro.crappycrypto};mitro.keycache.MakeKeyCache=function(){var b=[],c=null,d=null,f=mitro.keycache.CACHE_TARGET,g=null,a={size:function(){return b.length},push:function(k){b.push(k);a.size()>=f&&(g&&(g(),g=null),f=mitro.keycache.CACHE_TARGET);null!==c&&c(a)},isEmpty:function(){return 0===b.length},pop:function(){if(a.isEmpty())return console.log("WARNING: Not using key cache; will be SLOW"),e.generate();var k=b.pop();null!==d&&d(a);return k},toJson:function(a){return JSON.stringify(b.map(function(a){return a.toJson()}))},
loadFromJson:function(a){b=JSON.parse(a).map(function(a){return e.loadFromJson(a)})},setPushListener:function(a){c=a},setPopListener:function(a){d=a},setTemporaryLimit:function(b,c,e){if(0>b)e("invalid request");else if(g)e("Key generation already taking place in the background. Try again later.");else for(f=b+=a.size()+1,g=c,c=a.size();c<b;++c)d()},getNewRSAKeysAsync:function(b,c,d){try{for(var e=[],g=0;g<b;++g)e.push(a.pop());c(e)}catch(f){try{console.log("local exception ",f),console.log(f.stack),
console.log(f.message)}catch(h){}d({status:-1,userVisibleError:"Unknown local error",exceptionType:"JavascriptException",local_exception:f})}}};return a};mitro.keycache.getEntropyBytes=function(b){return forge.random.seedFileSync(b)};mitro.keycache.startFiller=function(b){var c=new h("keycache_webworker.js"),d="keyczar";e==mitro.crappycrypto&&(d="crappy");var f="crappy"!=d&&"undefined"!=typeof window&&window.crypto&&window.crypto.getRandomValues;c.addEventListener("message",function(a){a.data.key?
(console.log("got key from worker"),a=e.loadFromJson(a.data.key),b.push(a)):"log"==a.data.request?console.log("worker log:",a.data.message):"error"==a.data.request?console.log("worker exception:",a.data.message):console.log("unhandled worker message",a.data)});var g=function(){var a={request:"generate"};f&&(a.seed=mitro.keycache.getEntropyBytes(32));c.postMessage(a)};b.setPopListener(function(){g()});c.postMessage({request:"load",type:d});f&&(d=mitro.keycache.getEntropyBytes(1024),c.postMessage({request:"seed",
seed:d}));for(d=b.size();d<mitro.keycache.CACHE_TARGET;)g(),d+=1;return{stop:function(){c.terminate()}}}})();
